<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>äº¬å¯Œæ¯…å†·åª’æŸ¥è©¢ç³»çµ±</title>
    
    <script>
        // åœ¨é é¢æ¸²æŸ“å‰ç«‹å³åŸ·è¡Œï¼Œé˜²æ­¢é–ƒçˆ
        (function() {
            const savedTheme = localStorage.getItem('fuyi_theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
     crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class", 
            theme: {
                extend: {
                    colors: {
                        primary: "#3b82f6", 
                        "background-dark": "#191919", 
                        "surface-dark": "#1e293b",
                        "accent-blue": "#eff6ff"
                    }, 
                    fontFamily: {display: "Manrope"}
                }
            }
        };
    </script>
    <style>
        .offline-mode #offline-indicator { display: block; }
        /* é¿å…å…§å®¹è¢«åº•éƒ¨å°èˆªæ“‹ä½ */
        body { min-height: 100vh; padding-bottom: 110px; } 
        /* éš±è—æ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Steve Jobs ç´šåˆ¥çš„å¾®äº¤äº’ */
        .tap-feedback:active { transform: scale(0.95); transition: transform 0.1s ease-out; }
        
        /* é‡‘å±¬èˆ‡ç»ç’ƒèåˆè³ªæ„Ÿ - å¢åŠ ä¸é€æ˜åº¦é˜²æ­¢å­—é«”é‡ç–Š */
        .glass-header { 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px); 
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass-header { 
            background: rgba(25, 25, 25, 0.98); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background-image: linear-gradient(110deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.03) 100%);
        }

        /* è—è‰²é‡‘å±¬è³ªæ„Ÿ (é™½æ¥µæ°§åŒ–é‹é¢¨æ ¼) */
        .metallic-card {
            background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
            border: 1px solid rgba(59, 130, 246, 0.1);
            box-shadow: inset 0 1px 1px rgba(255,255,255,1);
        }
        .dark .metallic-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: inset 0 1px 0px rgba(255,255,255,0.05);
        }

        /* è—è‰²ç™¼å…‰ç´°ç¯€ */
        .blue-glow {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
        }
        .dark .blue-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        /* éª¨æ¶å±æ•ˆæœ - å¥‘åˆé‡‘å±¬æ„Ÿèˆ‡ç»ç’ƒæ“¬æ…‹ */
        .skeleton {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0.3) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
        }
        .dark .skeleton {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.3) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .skeleton::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0,
                rgba(255, 255, 255, 0.1) 20%,
                rgba(255, 255, 255, 0.2) 60%,
                rgba(255, 255, 255, 0)
            );
            animation: shimmer-effect 2s infinite;
        }
        .dark .skeleton::after {
            background: linear-gradient(
                90deg,
                rgba(59, 130, 246, 0) 0,
                rgba(59, 130, 246, 0.05) 20%,
                rgba(59, 130, 246, 0.1) 60%,
                rgba(59, 130, 246, 0)
            );
        }
        @keyframes shimmer-effect {
            100% { transform: translateX(100%); }
        }

        .glass-nav { 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px); 
            background: rgba(255, 255, 255, 0.98); 
            border-top: 1px solid rgba(0,0,0,0.08);
        }
        .dark .glass-nav { 
            background: rgba(20, 20, 20, 0.98); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* PWA å®‰è£æç¤ºå½ˆçª— */
        #pwa-install-prompt {
            transform: translateY(150%);
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #pwa-install-prompt.show {
            transform: translateY(0);
        }
        .ios-share-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%233b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>');
            background-repeat: no-repeat;
            vertical-align: middle;
            margin: 0 4px;
        }
    </style>
</head>

<body class="bg-white dark:bg-background-dark font-display antialiased text-gray-900 dark:text-white transition-colors duration-200">
    <!-- PWA å®‰è£å¼•å° (éš±è—ï¼Œç›´åˆ°è§¸ç™¼) -->
    <div id="pwa-install-prompt" class="fixed bottom-0 left-0 w-full z-[100] p-4 max-w-md mx-auto right-0">
        <div class="bg-white dark:bg-surface-dark rounded-3xl shadow-[0_-20px_50px_-12px_rgba(0,0,0,0.3)] border border-blue-500/20 p-6 flex flex-col gap-4">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <img src="/static/logo.png" alt="Logo" class="w-10 h-10 object-contain">
                </div>
                <div class="flex-1">
                    <h4 class="font-black text-lg tracking-tight">å®‰è£äº¬å¯Œæ¯… APP</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400">å°‡ç³»çµ±æ–°å¢è‡³ä¸»ç•«é¢ï¼ŒæŸ¥å†·åª’æ›´å¿«é€Ÿï¼</p>
                </div>
                <button onclick="dismissInstallPrompt()" class="text-gray-400">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            
            <div id="android-install-ui" class="hidden">
                <button onclick="triggerInstall()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-600/30 transition-all active:scale-95">
                    ç«‹å³å®‰è£åˆ°æ‰‹æ©Ÿ
                </button>
            </div>

            <div id="ios-install-ui" class="hidden text-sm text-gray-600 dark:text-gray-300 bg-blue-50/50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800/30">
                <p class="flex items-center flex-wrap leading-relaxed">
                    è«‹é»æ“Šä¸‹æ–¹å°èˆªåˆ—çš„ <span class="ios-share-icon"></span>
                    ç„¶å¾Œé¸æ“‡ <span class="font-bold text-blue-600 mx-1">ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</span> ä»¥å®Œæˆå®‰è£ã€‚
                </p>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-white dark:bg-background-dark flex flex-col">
        <!-- é›¢ç·šæç¤ºæ¢ -->
        <div id="offline-indicator" class="hidden bg-amber-500 text-white text-[10px] font-black py-1 text-center uppercase tracking-widest animate-pulse">
            é›¢ç·šæ¨¡å¼ï¼šç›®å‰æ­£åœ¨ç€è¦½å¿«å–è³‡æ–™
        </div>
        
        <header class="pt-8 px-6 pb-4 flex justify-between items-center glass-header sticky top-0 z-30 border-b border-gray-100/50 dark:border-gray-800/50 transition-colors duration-200">
            <div class="flex items-center gap-2">
                {% block header_left %}{% endblock %}
                <div>
                    <p class="text-[10px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-[0.2em] mb-1">Fuyi AC System</p>
                    <h1 class="text-2xl font-800 tracking-tight flex items-center gap-2">
                        {% block header_title %}å†·åª’æŸ¥è©¢ç³»çµ±{% endblock %}
                    </h1>
                </div>
            </div>

            <!-- ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• -->
            <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 dark:text-gray-400 transition-all hover:scale-110 active:scale-95 border border-gray-200 dark:border-gray-700">
                <span id="theme-icon" class="material-icons-round text-xl">light_mode</span>
            </button>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="px-5 pt-4">
              {% for category, message in messages %}
                <div class="p-4 rounded-2xl flex items-center gap-3 {% if category == 'error' %}bg-red-50 text-red-700 border border-red-100 dark:bg-red-900/20 dark:text-red-300 dark:border-red-800{% else %}bg-green-50 text-green-700 border border-green-100 dark:bg-green-900/20 dark:text-green-300 dark:border-green-800{% endif %}">
                  <span class="material-icons-round text-xl">
                    {% if category == 'error' %}error{% else %}check_circle{% endif %}
                  </span>
                  <p class="text-sm font-bold">{{ message }}</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <main class="p-5 space-y-6 flex-grow">
            {% block content %}{% endblock %}
        </main>

        <nav class="fixed bottom-0 w-full max-w-md glass-nav border-t border-gray-200/50 dark:border-gray-700/50 px-6 py-3 flex justify-between items-center z-40 pb-8 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.05)]">
            
            <a href="/about" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition-colors tap-feedback">   
                <span class="material-icons-round text-2xl">info</span>
                <span class="text-[10px] font-bold">é—œæ–¼</span>
            </a> 
            
            <a href="/tools" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition-colors tap-feedback">
                <span class="material-icons-round text-2xl">construction</span>
                <span class="text-[10px] font-bold">å·¥å…·ç®±</span>
            </a>
            
            <div class="relative -top-8">
                <button onclick="checkAdAndNavigate('/home')" class="w-16 h-16 bg-blue-600 rounded-2xl shadow-xl shadow-blue-500/40 flex items-center justify-center text-white transform active:scale-90 transition-all border-4 border-white dark:border-surface-dark focus:outline-none">
                    <span class="material-icons-round text-3xl">home</span>
                </button>
            </div>
            
            <a href="/profile" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition-colors tap-feedback">
                <span class="material-icons-round text-2xl">account_circle</span>
                <span class="text-[10px] font-bold">è³‡æ–™</span>
            </a>
            
            <a href="/logout" class="flex flex-col items-center gap-1 text-gray-400 hover:text-red-500 transition-colors tap-feedback">
                <span class="material-icons-round text-2xl">power_settings_new</span>
                <span class="text-[10px] font-bold">ç™»å‡º</span>
            </a>
        </nav>
    </div>

    <script>
        // === IndexedDB é›¢ç·šå¿«å–ç®¡ç† ===
        const DB_NAME = 'FuyiOfflineDB';
        const STORE_NAME = 'recent_cars';
        const MAX_OFFLINE_ITEMS = 10;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function saveCarToOffline(car) {
            const db = await initDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            
            // åŠ å…¥æ™‚é–“æˆ³è¨˜ä»¥ä¾¿æ’åº
            car.offline_at = Date.now();
            store.put(car);

            tx.oncomplete = async () => {
                // æª¢æŸ¥æ˜¯å¦è¶…é 10 ç­†ï¼Œè¶…éå‰‡åˆªé™¤æœ€èˆŠçš„
                const allItems = await getAllOfflineCars();
                if (allItems.length > MAX_OFFLINE_ITEMS) {
                    allItems.sort((a, b) => a.offline_at - b.offline_at);
                    const toDelete = allItems.slice(0, allItems.length - MAX_OFFLINE_ITEMS);
                    const delTx = db.transaction(STORE_NAME, 'readwrite');
                    const delStore = delTx.objectStore(STORE_NAME);
                    toDelete.forEach(item => delStore.delete(item.id));
                }
            };
        }

        function getAllOfflineCars() {
            return new Promise(async (resolve) => {
                const db = await initDB();
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function getOfflineCar(id) {
            const db = await initDB();
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            return new Promise((resolve) => {
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        }

        // --- æœ€è¿‘ç´€éŒ„ç®¡ç† ---
        const HISTORY_KEY = 'fuyi_recent_history';
        function addToHistory(item) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            history = history.filter(h => h.id !== item.id);
            history.unshift(item);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
        }

        // --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ ---
        function applyTheme(theme) {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (!icon) return; // é˜²æ­¢åœ¨æ²’æœ‰ icon çš„é é¢å ±éŒ¯

            if (theme === 'dark') {
                html.classList.add('dark');
                icon.innerText = 'light_mode';
            } else {
                html.classList.remove('dark');
                icon.innerText = 'dark_mode';
            }
            localStorage.setItem('fuyi_theme', theme);
        }

        function toggleTheme() {
            const current = localStorage.getItem('fuyi_theme') || 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
        }

        // åˆå§‹åŒ–åœ–ç¤º (å› ç‚º CSS å·²ç¶“åœ¨ Head è™•ç†é class äº†)
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('fuyi_theme') || 'light';
            applyTheme(savedTheme);
        });

        // --- PWA å®‰è£é‚è¼¯ ---
        let deferredPrompt;
        const installPrompt = document.getElementById('pwa-install-prompt');
        const androidUI = document.getElementById('android-install-ui');
        const iosUI = document.getElementById('ios-install-ui');

        // åµæ¸¬æ˜¯å¦å·²åœ¨ç¨ç«‹æ¨¡å¼ (å·²å®‰è£)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        window.addEventListener('beforeinstallprompt', (e) => {
            // é˜²æ­¢ Android é è¨­æç¤ºå½ˆå‡º
            e.preventDefault();
            deferredPrompt = e;
            
            // åªæœ‰åœ¨æœªå®‰è£ä¸”ä¸åœ¨æ’é™¤é é¢æ™‚é¡¯ç¤º
            if (!isStandalone) {
                showInstallUI('android');
            }
        });

        // iOS åµæ¸¬èˆ‡å¼•å°
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS && !isStandalone) {
            // å»¶é²ä¸€é»é»é¡¯ç¤ºï¼Œé¿å…è“‹æ‰ç™»å…¥ç•«é¢
            setTimeout(() => showInstallUI('ios'), 2000);
        }

        function showInstallUI(platform) {
            installPrompt.classList.add('show');
            if (platform === 'android') androidUI.classList.remove('hidden');
            if (platform === 'ios') iosUI.classList.remove('hidden');
        }

        function dismissInstallPrompt() {
            installPrompt.classList.remove('show');
        }

        async function triggerInstall() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to install: ${outcome}`);
            deferredPrompt = null;
            dismissInstallPrompt();
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js');
        }

        // ç›£è½é›¢ç·šç‹€æ…‹
        window.addEventListener('online', () => {
            document.body.classList.remove('offline-mode');
            console.log("ğŸŒ ç¶²è·¯å·²æ¢å¾©");
        });
        window.addEventListener('offline', () => {
            document.body.classList.add('offline-mode');
            console.log("ğŸš« ç›®å‰è™•æ–¼é›¢ç·šç‹€æ…‹");
        });
        if (!navigator.onLine) document.body.classList.add('offline-mode');

        // --- æ ¸å¿ƒåŒæ­¥é‚è¼¯ ---
        async function syncDatabase() {
            const localVersion = localStorage.getItem('fuyi_db_version');
            try {
                // é€™è£¡å¯ä»¥å…ˆåšä¸€å€‹è¼•é‡çš„ç‰ˆæœ¬æª¢æŸ¥ï¼Œæˆ–è€…ç›´æ¥èª¿ç”¨åŒæ­¥ä»‹é¢
                // ç‚ºäº†ç°¡å–®ä¸”æ¸›å°‘è«‹æ±‚æ¬¡æ•¸ï¼Œæˆ‘å€‘ç›´æ¥èª¿ç”¨ db_sync
                // å¦‚æœå¾Œç«¯æœ‰å¿«å–ï¼Œé€™å€‹è«‹æ±‚ä¹Ÿéå¸¸å¿«
                const res = await fetch('/api/db_sync');
                const cloud = await res.json();

                if (cloud.version !== localVersion) {
                    console.log("ğŸ”„ åµæ¸¬åˆ°æ–°ç‰ˆæœ¬:", cloud.version, "æ›´æ–°æœ¬åœ°è³‡æ–™åº«...");
                    localStorage.setItem('fuyi_db_data', JSON.stringify(cloud.data));
                    localStorage.setItem('fuyi_db_version', cloud.version);
                    return true; // æœ‰æ›´æ–°
                }
            } catch (e) {
                console.error("âŒ åŒæ­¥å¤±æ•—:", e);
            }
            return false; // ç„¡æ›´æ–°æˆ–å¤±æ•—
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥åŒæ­¥ (åƒ…åœ¨å·²ç™»å…¥ç‹€æ…‹ä¸‹åŸ·è¡Œ)
        {% if current_user.is_authenticated %}
        if (window.location.pathname === '/home') {
            syncDatabase();
        }
        {% endif %}

        // === æ ¸å¿ƒå°èˆªèˆ‡å»£å‘Šé‚è¼¯ ===
        function checkAdAndNavigate(targetUrl) {
            
            // --- æ¨¡å¼ Aï¼šå¯¦é«”å» å•†åŒ…æœˆ (æ¯3æ¬¡è·³è½‰ä¸€æ¬¡æ‰‹å¯«å»£å‘Š) ---
            // å·²ç”± fuyi-dev å•Ÿç”¨ï¼Œç”¨æ–¼æ¸¬è©¦ ad_page.html å„ªåŒ–æ•ˆæœ
            let count = parseInt(localStorage.getItem('fuyi_click_count') || '0');
            count++;
            localStorage.setItem('fuyi_click_count', count);
            console.log("ç´¯ç©é»æ“Š:", count);

            if (count % 3 === 0) {
                // è·³å»å»£å‘Šé ï¼Œä¸¦æ”œå¸¶ç›®æ¨™ç¶²å€
                window.location.href = '/ad?next=' + encodeURIComponent(targetUrl);
                return; 
            }
            
            // --- æ¨¡å¼ Bï¼šGoogle AdSense (è‡ªå‹•æ’é å»£å‘Š) ---
            // è‹¥éœ€è¦åˆ‡æ›å› Google æ¨¡å¼ï¼Œè«‹è¨»è§£ä¸Šæ–¹æ¨¡å¼ A ä¸¦å–æ¶ˆä¸‹æ–¹è¨»è§£
            window.location.href = targetUrl;
        }
    </script>
</body>
</html>