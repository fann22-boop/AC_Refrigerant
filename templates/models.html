{% extends 'base.html' %}

{% block header_title %}
<button onclick="checkAdAndNavigate('/home')" class="mr-2 inline-flex items-center text-gray-400 hover:text-blue-500 transition-colors focus:outline-none">
    <span class="material-icons-round">arrow_back</span>
</button>
{{ brand }} 車系
{% endblock %}

{% block content %}
<div class="relative group sticky top-0 z-10 mb-4 bg-gray-50 dark:bg-background-dark pb-2">
    <div class="absolute inset-y-0 left-0 pl-4 pb-2 flex items-center pointer-events-none">
        <span class="material-icons-outlined text-gray-400 group-focus-within:text-blue-500 transition-colors">search</span>
    </div>
    <input type="text" id="searchInput" placeholder="搜尋車型、規格或年份..." class="block w-full pl-11 pr-4 py-4 bg-white dark:bg-surface-dark border border-gray-200 dark:border-gray-700 rounded-xl font-medium focus:ring-2 focus:ring-primary/20 focus:border-primary shadow-sm transition-all text-gray-900 dark:text-white placeholder-gray-400">
</div>

<div class="mb-4" id="adBlock">
    <a href="https://www.google.com" target="_blank" class="block relative overflow-hidden bg-gradient-to-r from-amber-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border border-amber-200 dark:border-yellow-700/50 rounded-xl p-4 shadow-sm group">
        
        <span class="absolute top-0 right-0 bg-amber-200 dark:bg-yellow-700 text-amber-900 dark:text-yellow-100 text-[10px] font-bold px-2 py-0.5 rounded-bl-lg">
            SPONSORED
        </span>

        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-white dark:bg-yellow-900/40 rounded-full flex items-center justify-center shadow-sm text-amber-500 group-hover:scale-110 transition-transform duration-300">
                <span class="material-icons-outlined text-2xl">local_offer</span>
            </div>
            
            <div class="flex-1">
                <h3 class="text-amber-900 dark:text-yellow-100 font-bold text-sm">
                    {{ brand }} 專用冷凍油促銷
                </h3>
                <p class="text-amber-700 dark:text-yellow-200/70 text-xs mt-0.5">
                    原廠認證規格，限時買 5 送 1！
                </p>
            </div>
            
            <span class="material-icons-round text-amber-400 group-hover:translate-x-1 transition-transform">arrow_forward_ios</span>
        </div>
    </a>
</div>

<div id="noResults" class="hidden flex-col items-center justify-center py-12 text-center">
    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
        <span class="material-icons-outlined text-3xl text-gray-400">search_off</span>
    </div>
    <p class="text-gray-500 dark:text-gray-400 font-medium">找不到符合的車型</p>
    <p class="text-gray-400 text-sm mt-1">請嘗試不同的關鍵字</p>
</div>

<div class="space-y-3 pb-4" id="carList">
    <!-- 骨架屏 -->
    <div class="skeleton h-32 w-full rounded-2xl"></div>
    <div class="skeleton h-32 w-full rounded-2xl"></div>
    <div class="skeleton h-32 w-full rounded-2xl"></div>
    <div class="skeleton h-32 w-full rounded-2xl"></div>
</div>

<script>
    // --- 本地優先渲染邏輯 ---
    function renderModelsFromLocal() {
        const localData = localStorage.getItem('fuyi_db_data');
        if (!localData) return;

        try {
            const db = JSON.parse(localData);
            const brandName = "{{ brand }}";
            const cars = db.filter(item => item.brand === brandName);
            
            if (cars.length === 0) return;

            const carList = document.getElementById('carList');
            // 延遲渲染以展示骨架屏效果
            setTimeout(() => {
                carList.innerHTML = cars.map(car => `
                    <div onclick="if('${car.id}' && '${car.id}' !== 'undefined') { checkAdAndNavigate('/detail/${car.id}') } else { alert('資料缺少編號'); }" 
                         class="car-item bg-white dark:bg-surface-dark rounded-2xl p-5 shadow-sm border border-gray-100 dark:border-gray-700 group hover:border-blue-400 dark:hover:border-blue-500 transition-all relative overflow-hidden cursor-pointer select-none transform active:scale-[0.98]"
                         data-search="${car.model} ${car.spec} ${car.generation}">
                        
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gray-100 dark:bg-gray-700 group-hover:bg-blue-500 transition-colors pointer-events-none"></div>

                        <div class="flex flex-col gap-1 pointer-events-none">
                            <h4 class="font-black text-gray-900 dark:text-white text-xl leading-tight tracking-tight">
                                ${car.model}
                            </h4>
                            <p class="text-base font-bold text-gray-500 dark:text-gray-300">
                                ${car.spec}
                            </p>
                            <div class="flex items-center justify-between mt-2">
                                <p class="text-base font-bold text-gray-800 dark:text-gray-200">
                                    ${car.generation}
                                </p>
                                <span class="bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 text-[10px] font-black px-3 py-1 rounded-lg uppercase border border-blue-100 dark:border-blue-800 flex-shrink-0">
                                    ${car.refrigerant_type}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }, 300);
        } catch (e) {
            console.error("解析本地資料失敗", e);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderModelsFromLocal();

        const searchInput = document.getElementById('searchInput');
        const noResults = document.getElementById('noResults');

        searchInput.addEventListener('input', function(e) {
            const carItems = document.querySelectorAll('.car-item');
            const searchTerm = e.target.value.toLowerCase().trim();
            let hasResults = false;

            carItems.forEach(item => {
                const searchableText = item.getAttribute('data-search').toLowerCase();
                if (searchableText.includes(searchTerm)) {
                    item.style.display = 'flex';
                    hasResults = true;
                } else {
                    item.style.display = 'none';
                }
            });

            if (hasResults) {
                noResults.classList.add('hidden');
                noResults.classList.remove('flex');
            } else {
                noResults.classList.remove('hidden');
                noResults.classList.add('flex');
            }
        });
    });
</script>
{% endblock %}